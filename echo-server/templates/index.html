<!DOCTYPE html>
<html>
<head>
    <title>{{.Title}}</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Echo Service</h1>
            <div class="user-info">
                Welcome, {{.User.Username}}! 
                <a href="/logout">Logout</a>
            </div>
        </header>
        
        {{if .Error}}
            <div class="alert error">{{.Error}}</div>
        {{end}}
        
        <div class="chat-container">
            <div class="message-form">
                <input type="text" id="message-input" placeholder="Type your message...">
                <button onclick="sendMessage()">Send</button>
            </div>
            
            <div class="history-container">
                <h2>Message History</h2>
                <div id="messages">
                    {{range .Messages}}
                    <div class="message" id="message-{{.ID}}">
                        <button class="delete-btn" onclick="deleteMessage({{.ID}})"><i class="fa-solid fa-trash"></i></button>
                        <div class="original">{{.OriginalMessage}}</div>
                        <div class="reversed">{{.ReversedMessage}}</div>
                        <div class="timestamp">{{.CreatedAt.Format "2006-01-02 15:04"}}</div>
                    </div>
                    {{end}}
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            if (message === '') return;
            
            const params = new URLSearchParams();
            params.append('message', message);
            
            axios.post('/echo', params)
            .then(response => {
                const data = response.data;
                addMessageToHistory(data.id, data.original, data.reversed, data.timestamp.substring(0, 16));
                input.value = '';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to send message');
            });
        }
        
        function addMessageToHistory(id, original, reversed, timestamp) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.id = 'message-' + id;

            // Change 4: Replaced the emoji in the JavaScript with the Font Awesome icon tag
            messageDiv.innerHTML = `
                <button class="delete-btn" onclick="deleteMessage(${id})"><i class="fa-solid fa-trash"></i></button>
                <div class="original">${original}</div>
                <div class="reversed">${reversed}</div>
                <div class="timestamp">${timestamp}</div>
            `;
            
            messagesDiv.insertBefore(messageDiv, messagesDiv.firstChild);
        }

        function deleteMessage(messageId) {
            if (!confirm('Are you sure you want to delete this message?')) {
                return;
            }

            axios.delete('/message/' + messageId)
            .then(response => {
                if (response.data.success) {
                    const messageElement = document.getElementById('message-' + messageId);
                    if (messageElement) {
                        messageElement.remove();
                    }
                }
            })
            .catch(error => {
                console.error('Error deleting message:', error);
                alert('Failed to delete the message. Please try again.');
            });
        }
        
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>